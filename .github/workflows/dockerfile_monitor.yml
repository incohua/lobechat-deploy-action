name: Monitor LobeChat Construct Files

on:
  schedule:
    - cron: '* 6  * * *' 
  workflow_dispatch: 

jobs:
  notify-changes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
    
    - name: Check remote repository changes
      id: check_changes
      run: |
        # å…‹éš†è¿œç«¯ä»“åº“
        git clone https://github.com/lobehub/lobe-chat.git remote-repo
        cd remote-repo
        
        # èŽ·å–å½“å‰æäº¤SHA
        CURRENT_SHA=$(git rev-parse HEAD)
        
        # æ£€æŸ¥æœ¬åœ°æ˜¯å¦å­˜å‚¨äº†ä¸Šæ¬¡çš„SHA
        cd ..
        LAST_SHA=""
        if [ -f last_sha.txt ]; then
          LAST_SHA=$(cat last_sha.txt)
        fi
        
        echo "Last SHA: $LAST_SHA"
        echo "Current SHA: $CURRENT_SHA"
        
        # å¦‚æžœSHAä¸åŒï¼Œæ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦æœ‰å˜æ›´
        DOCKERFILE_CHANGED=false
        WORKFLOW_CHANGED=false
        COMMIT_MESSAGE=""
        
        if [ "$LAST_SHA" != "$CURRENT_SHA" ] && [ -n "$LAST_SHA" ]; then
          cd remote-repo
          
          # èŽ·å–å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨
          CHANGED_FILES=$(git diff --name-only $LAST_SHA HEAD 2>/dev/null || echo "")
          
          # æ£€æŸ¥æ˜¯å¦åŒ…å«ç›®æ ‡æ–‡ä»¶
          if echo "$CHANGED_FILES" | grep -q "^Dockerfile.database$"; then
            DOCKERFILE_CHANGED=true
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^\.github/workflows/docker-database\.yml$"; then
            WORKFLOW_CHANGED=true
          fi
          
          # èŽ·å–æäº¤ä¿¡æ¯
          COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          cd ..
        fi
        
        # æ›´æ–°SHAè®°å½•
        echo "$CURRENT_SHA" > last_sha.txt
        
        # è®¾ç½®è¾“å‡ºå˜é‡
        echo "dockerfile_changed=$DOCKERFILE_CHANGED" >> $GITHUB_OUTPUT
        echo "workflow_changed=$WORKFLOW_CHANGED" >> $GITHUB_OUTPUT
        echo "commit_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
    
    - name: Cache last SHA
      uses: actions/cache@v3
      with:
        path: last_sha.txt
        key: lobehub-last-sha-${{ steps.check_changes.outputs.commit_sha }}
        restore-keys: |
          lobehub-last-sha-
    
    - name: Send Bark notification for Dockerfile.database
      if: steps.check_changes.outputs.dockerfile_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat] Dockerfile.databaseæ–‡ä»¶å‘ç”Ÿå˜åŒ–",
               "body": "Dockerfile.databaseæ–‡ä»¶å‘ç”Ÿå˜åŒ–\n\næäº¤ä¿¡æ¯: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/Dockerfile.database"
             }'
    
    - name: Send Bark notification for workflow file
      if: steps.check_changes.outputs.workflow_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat-Github-Actions] docker-database.ymlå·¥ä½œæµæ–‡ä»¶å‘ç”Ÿå˜åŒ–",
               "body": "docker-database.ymlå·¥ä½œæµå·²æ›´æ–°\n\næäº¤ä¿¡æ¯: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/.github/workflows/docker-database.yml"
             }'
    
    - name: Summary
      run: |
        echo "## æ–‡ä»¶å˜æ›´ç›‘æŽ§ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- Dockerfile.database: ${{ steps.check_changes.outputs.dockerfile_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "- docker-database.yml: ${{ steps.check_changes.outputs.workflow_changed }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.check_changes.outputs.dockerfile_changed }}" == "true" || "${{ steps.check_changes.outputs.workflow_changed }}" == "true" ]]; then
          echo "- ðŸ“± Barké€šçŸ¥å·²å‘é€" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â„¹ï¸ æœªæ£€æµ‹åˆ°ç›®æ ‡æ–‡ä»¶å˜æ›´" >> $GITHUB_STEP_SUMMARY
        fi