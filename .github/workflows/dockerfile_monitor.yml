name: remote-repo-file-monitor

on:
  schedule:
    - cron: '0 6 * * *'  # 每天6点执行
  workflow_dispatch: 

jobs:
  notify-changes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
    
    - name: Restore last SHA cache
      uses: actions/cache/restore@v3
      id: cache-restore
      with:
        path: last_sha.txt
        key: lobehub-last-sha
    
    - name: Check remote repository changes
      id: check_changes
      run: |
        set -e  # 出错时退出
        
        # 浅克隆远端仓库
        if ! git clone --depth=50 https://github.com/lobehub/lobe-chat.git remote-repo; then
          echo "Failed to clone repository"
          exit 1
        fi
        
        cd remote-repo
        CURRENT_SHA=$(git rev-parse HEAD)
        
        # 获取上次的SHA
        cd ..
        LAST_SHA=""
        if [ -f last_sha.txt ]; then
          LAST_SHA=$(cat last_sha.txt)
        fi
        
        echo "Last SHA: $LAST_SHA"
        echo "Current SHA: $CURRENT_SHA"
        
        # 检查变更逻辑...
        # (保持原有逻辑，但添加错误处理)
        
        # 更新SHA记录
        echo "$CURRENT_SHA" > last_sha.txt
    
    - name: Save last SHA cache
      uses: actions/cache/save@v3
      if: always()
      with:
        path: last_sha.txt
        key: lobehub-last-sha-${{ github.run_number }}
    
    - name: Send Bark notification for Dockerfile.database
      if: steps.check_changes.outputs.dockerfile_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat] Dockerfile.database文件发生变化",
               "body": "Dockerfile.database文件发生变化\n\n提交信息: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/Dockerfile.database"
             }'
    
    - name: Send Bark notification for workflow file
      if: steps.check_changes.outputs.workflow_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat-Github-Actions] docker-database.yml工作流文件发生变化",
               "body": "docker-database.yml工作流已更新\n\n提交信息: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/.github/workflows/docker-database.yml"
             }'
    
    - name: Summary
      run: |
        echo "## 文件变更监控结果" >> $GITHUB_STEP_SUMMARY
        echo "- Dockerfile.database: ${{ steps.check_changes.outputs.dockerfile_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "- docker-database.yml: ${{ steps.check_changes.outputs.workflow_changed }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.check_changes.outputs.dockerfile_changed }}" == "true" || "${{ steps.check_changes.outputs.workflow_changed }}" == "true" ]]; then
          echo "- 📱 Bark通知已发送" >> $GITHUB_STEP_SUMMARY
        else
          echo "- ℹ️ 未检测到目标文件变更" >> $GITHUB_STEP_SUMMARY
        fi
