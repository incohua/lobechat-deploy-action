name: Monitor Dockerfile_database Changes

on:
  schedule:
    - cron: '0 * * * *'  # æ¯å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:

env:
  REPO_OWNER: lobehub
  REPO_NAME: lobe-chat
  TARGET_FILE: dockerfile.database

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      
    - name: Setup monitoring cache
      uses: actions/cache@v3
      with:
        path: .monitor-cache/
        key: lobechat-monitor-${{ github.run_id }}
        restore-keys: |
          lobechat-monitor-

    - name: Initialize monitoring
      run: |
        mkdir -p .monitor-cache
        
    - name: Check for changes
      id: monitor
      run: |
        set -e
        
        # èŽ·å–ç›®æ ‡æ–‡ä»¶çš„æœ€æ–°æäº¤
        API_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/commits"
        echo "ðŸ” Checking commits for ${{ env.TARGET_FILE }}..."
        
        RESPONSE=$(curl -s -f "$API_URL?path=${{ env.TARGET_FILE }}&per_page=1" || echo "[]")
        
        if [ "$RESPONSE" = "[]" ] || [ -z "$RESPONSE" ]; then
          echo "âŒ No commits found for ${{ env.TARGET_FILE }}"
          exit 0
        fi
        
        # å®‰å…¨åœ°æå–æ•°æ®ï¼Œå¤„ç†ç‰¹æ®Šå­—ç¬¦
        LATEST_COMMIT=$(echo "$RESPONSE" | jq -r '.[0].sha // "unknown"')
        COMMIT_MESSAGE_RAW=$(echo "$RESPONSE" | jq -r '.[0].commit.message // "No message"')
        COMMIT_AUTHOR=$(echo "$RESPONSE" | jq -r '.[0].commit.author.name // "Unknown"')
        COMMIT_DATE=$(echo "$RESPONSE" | jq -r '.[0].commit.author.date // "Unknown"')
        COMMIT_URL=$(echo "$RESPONSE" | jq -r '.[0].html_url // ""')
        
        # æ¸…ç†æäº¤æ¶ˆæ¯ï¼Œç§»é™¤ç‰¹æ®Šå­—ç¬¦å’Œæ¢è¡Œç¬¦
        COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE_RAW" | tr -d '\n\r' | sed 's/[*]/Â·/g' | head -c 100)
        
        # å°†æ•°æ®å†™å…¥æ–‡ä»¶è€Œä¸æ˜¯ä½¿ç”¨ GITHUB_OUTPUTï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
        echo "$LATEST_COMMIT" > .monitor-cache/current_commit.txt
        echo "$COMMIT_MESSAGE" > .monitor-cache/current_message.txt
        echo "$COMMIT_AUTHOR" > .monitor-cache/current_author.txt
        echo "$COMMIT_DATE" > .monitor-cache/current_date.txt
        echo "$COMMIT_URL" > .monitor-cache/current_url.txt
        
        echo "ðŸ“Š Current commit: $LATEST_COMMIT"
        echo "ðŸ“ Message: $COMMIT_MESSAGE"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        CACHE_FILE=".monitor-cache/last_commit.txt"
        if [ -f "$CACHE_FILE" ]; then
          LAST_COMMIT=$(cat "$CACHE_FILE" 2>/dev/null || echo "")
          if [ "$LATEST_COMMIT" != "$LAST_COMMIT" ] && [ -n "$LAST_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… New changes detected! ($LAST_COMMIT -> $LATEST_COMMIT)"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new changes"
          fi
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ðŸ†• First time setup"
        fi
        
        # ä¿å­˜å½“å‰æäº¤
        echo "$LATEST_COMMIT" > "$CACHE_FILE"

    - name: Send Bark notification
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        BARK_URL: ${{ secrets.BARK_URL }}
      run: |
        # ä»Žæ–‡ä»¶è¯»å–æ•°æ®ï¼ˆé¿å…ç‰¹æ®Šå­—ç¬¦é—®é¢˜ï¼‰
        LATEST_COMMIT=$(cat .monitor-cache/current_commit.txt 2>/dev/null || echo "unknown")
        COMMIT_MESSAGE=$(cat .monitor-cache/current_message.txt 2>/dev/null || echo "No message")
        COMMIT_AUTHOR=$(cat .monitor-cache/current_author.txt 2>/dev/null || echo "Unknown")
        COMMIT_DATE=$(cat .monitor-cache/current_date.txt 2>/dev/null || echo "Unknown")
        COMMIT_URL=$(cat .monitor-cache/current_url.txt 2>/dev/null || echo "")
        
        # æ ¼å¼åŒ–æ—¶é—´
        if [ "$COMMIT_DATE" != "Unknown" ]; then
          FORMATTED_DATE=$(date -d "$COMMIT_DATE" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$COMMIT_DATE")
        else
          FORMATTED_DATE="Unknown"
        fi
        
        # æž„é€  JSON è´Ÿè½½ï¼Œç¡®ä¿ç‰¹æ®Šå­—ç¬¦è¢«æ­£ç¡®è½¬ä¹‰
        cat > notification.json <<EOF
        {
          "title": "ðŸ³ LobeChat Database Dockerfile å·²æ›´æ–°",
          "body": "ðŸ“ ${COMMIT_MESSAGE}\n\nðŸ‘¤ ä½œè€…: ${COMMIT_AUTHOR}\nðŸ“… æ—¶é—´: ${FORMATTED_DATE}\nðŸ” æäº¤: ${LATEST_COMMIT:0:8}\n\nç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’",
          "group": "GitHubç›‘æŽ§",
          "url": "${COMMIT_URL}",
          "sound": "update",
          "badge": 1
        }
EOF
        
        # å‘é€é€šçŸ¥
        if [ -n "$BARK_URL" ]; then
          HTTP_CODE=$(curl -w "%{http_code}" -s -o response.txt -X POST "$BARK_URL" \
            -H "Content-Type: application/json; charset=utf-8" \
            -d @notification.json)
          
          echo "ðŸ“± Bark notification sent"
          echo "ðŸ“Š HTTP Code: $HTTP_CODE"
          
          if [ -f response.txt ]; then
            echo "ðŸ“„ Response:"
            cat response.txt
          fi
          
          # æ£€æŸ¥æ˜¯å¦å‘é€æˆåŠŸ
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Notification sent successfully"
          else
            echo "âš ï¸  Notification may have failed (HTTP $HTTP_CODE)"
          fi
        else
          echo "âŒ BARK_URL not configured"
          exit 1
        fi

    - name: Cleanup
      if: always()
      run: |
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f notification.json response.txt
        
        # æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
        if [ -d .monitor-cache ]; then
          echo "ðŸ“ Cache contents:"
          ls -la .monitor-cache/ || true
        fi