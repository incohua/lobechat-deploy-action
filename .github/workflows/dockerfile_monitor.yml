name: remote-repo-file-monitor

on:
  schedule:
    - cron: '0 6 * * *'  # æ¯å¤©6ç‚¹æ‰§è¡Œ
  workflow_dispatch: 

jobs:
  notify-changes:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
    
    - name: Restore last SHA cache
      uses: actions/cache/restore@v3
      id: cache-restore
      with:
        path: last_sha.txt
        key: lobehub-last-sha
    
    - name: Check remote repository changes
      id: check_changes
      run: |
        set -e  # å‡ºé”™æ—¶é€€å‡º
        
        # æµ…å…‹éš†è¿œç«¯ä»“åº“
        if ! git clone --depth=50 https://github.com/lobehub/lobe-chat.git remote-repo; then
          echo "Failed to clone repository"
          exit 1
        fi
        
        cd remote-repo
        CURRENT_SHA=$(git rev-parse HEAD)
        
        # èŽ·å–ä¸Šæ¬¡çš„SHA
        cd ..
        LAST_SHA=""
        if [ -f last_sha.txt ]; then
          LAST_SHA=$(cat last_sha.txt)
        fi
        
        echo "Last SHA: $LAST_SHA"
        echo "Current SHA: $CURRENT_SHA"
        
        # åˆå§‹åŒ–è¾“å‡ºå˜é‡
        echo "dockerfile_changed=false" >> $GITHUB_OUTPUT
        echo "workflow_changed=false" >> $GITHUB_OUTPUT
        echo "commit_message=" >> $GITHUB_OUTPUT
        echo "commit_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
        
        # å¦‚æžœæ˜¯é¦–æ¬¡è¿è¡Œæˆ– SHA ç›¸åŒï¼Œè·³è¿‡æ£€æŸ¥
        if [ -z "$LAST_SHA" ] || [ "$LAST_SHA" = "$CURRENT_SHA" ]; then
          echo "No changes detected or first run"
          echo "$CURRENT_SHA" > ../last_sha.txt
          exit 0
        fi
        
        # èŽ·å–æœ€æ–°æäº¤ä¿¡æ¯
        COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "Latest commit: $COMMIT_MESSAGE"
        
        # æ£€æŸ¥ Dockerfile.database æ˜¯å¦åœ¨å˜æ›´ä¸­
        if git diff --name-only "$LAST_SHA".."$CURRENT_SHA" | grep -q "^Dockerfile\.database$"; then
          echo "Dockerfile.database has changed!"
          echo "dockerfile_changed=true" >> $GITHUB_OUTPUT
        else
          echo "Dockerfile.database unchanged"
        fi
        
        # æ£€æŸ¥ workflow æ–‡ä»¶æ˜¯å¦å˜æ›´
        if git diff --name-only "$LAST_SHA".."$CURRENT_SHA" | grep -q "^\.github/workflows/docker-database\.yml$"; then
          echo "docker-database.yml workflow has changed!"
          echo "workflow_changed=true" >> $GITHUB_OUTPUT
        else
          echo "docker-database.yml workflow unchanged"
        fi
        
        # æ›´æ–°SHAè®°å½•
        cd ..
        echo "$CURRENT_SHA" > last_sha.txt
    
    - name: Save last SHA cache
      uses: actions/cache/save@v3
      if: always()
      with:
        path: last_sha.txt
        key: lobehub-last-sha
    
    - name: Send Bark notification for Dockerfile.database
      if: steps.check_changes.outputs.dockerfile_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat] Dockerfile.databaseæ–‡ä»¶å‘ç”Ÿå˜åŒ–",
               "body": "Dockerfile.databaseæ–‡ä»¶å‘ç”Ÿå˜åŒ–\n\næäº¤ä¿¡æ¯: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/Dockerfile.database"
             }'
    
    - name: Send Bark notification for workflow file
      if: steps.check_changes.outputs.workflow_changed == 'true'
      run: |
        curl -X "POST" "${{secrets.BARK_URL}}" \
             -H 'Content-Type: application/json; charset=utf-8' \
             -d '{
               "title": "[LobeChat-Github-Actions] docker-database.ymlå·¥ä½œæµæ–‡ä»¶å‘ç”Ÿå˜åŒ–",
               "body": "docker-database.ymlå·¥ä½œæµå·²æ›´æ–°\n\næäº¤ä¿¡æ¯: ${{ steps.check_changes.outputs.commit_message }}",
               "badge": 1,
               "sound": "minuet",
               "icon": "https://avatars.githubusercontent.com/u/131470832?s=200&v=4",
               "group": "LobeChat",
               "level": "active",
               "url": "https://github.com/lobehub/lobe-chat/blob/${{ steps.check_changes.outputs.commit_sha }}/.github/workflows/docker-database.yml"
             }'
    
    - name: Summary
      run: |
        echo "## æ–‡ä»¶å˜æ›´ç›‘æŽ§ç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "- Dockerfile.database: ${{ steps.check_changes.outputs.dockerfile_changed }}" >> $GITHUB_STEP_SUMMARY
        echo "- docker-database.yml: ${{ steps.check_changes.outputs.workflow_changed }}" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ steps.check_changes.outputs.dockerfile_changed }}" == "true" || "${{ steps.check_changes.outputs.workflow_changed }}" == "true" ]]; then
          echo "- ðŸ“± Barké€šçŸ¥å·²å‘é€" >> $GITHUB_STEP_SUMMARY
        else
          echo "- â„¹ï¸ æœªæ£€æµ‹åˆ°ç›®æ ‡æ–‡ä»¶å˜æ›´" >> $GITHUB_STEP_SUMMARY
        fi
