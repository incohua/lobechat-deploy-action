name: Monitor LobeChat Database Dockerfile

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

env:
  REPO_OWNER: lobehub
  REPO_NAME: lobe-chat
  TARGET_FILE: dockerfile.database

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      
    - name: Setup monitoring cache
      uses: actions/cache@v3
      with:
        path: .monitor-cache/
        key: lobechat-monitor-${{ github.run_id }}
        restore-keys: |
          lobechat-monitor-

    - name: Initialize monitoring
      run: |
        mkdir -p .monitor-cache
        
    - name: Check for changes
      id: monitor
      run: |
        set -e
        
        API_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/commits"
        echo "Checking commits for ${{ env.TARGET_FILE }}..."
        
        RESPONSE=$(curl -s -f "$API_URL?path=${{ env.TARGET_FILE }}&per_page=1" || echo "[]")
        
        if [ "$RESPONSE" = "[]" ] || [ -z "$RESPONSE" ]; then
          echo "No commits found for ${{ env.TARGET_FILE }}"
          exit 0
        fi
        
        LATEST_COMMIT=$(echo "$RESPONSE" | jq -r '.[0].sha // "unknown"')
        COMMIT_MESSAGE_RAW=$(echo "$RESPONSE" | jq -r '.[0].commit.message // "No message"')
        COMMIT_AUTHOR=$(echo "$RESPONSE" | jq -r '.[0].commit.author.name // "Unknown"')
        COMMIT_DATE=$(echo "$RESPONSE" | jq -r '.[0].commit.author.date // "Unknown"')
        COMMIT_URL=$(echo "$RESPONSE" | jq -r '.[0].html_url // ""')
        
        COMMIT_MESSAGE=$(echo "$COMMIT_MESSAGE_RAW" | tr -d '\n\r' | sed 's/[*]/Â·/g' | head -c 100)
        
        echo "$LATEST_COMMIT" > .monitor-cache/current_commit.txt
        echo "$COMMIT_MESSAGE" > .monitor-cache/current_message.txt
        echo "$COMMIT_AUTHOR" > .monitor-cache/current_author.txt
        echo "$COMMIT_DATE" > .monitor-cache/current_date.txt
        echo "$COMMIT_URL" > .monitor-cache/current_url.txt
        
        echo "Current commit: $LATEST_COMMIT"
        echo "Message: $COMMIT_MESSAGE"
        
        CACHE_FILE=".monitor-cache/last_commit.txt"
        if [ -f "$CACHE_FILE" ]; then
          LAST_COMMIT=$(cat "$CACHE_FILE" 2>/dev/null || echo "")
          if [ "$LATEST_COMMIT" != "$LAST_COMMIT" ] && [ -n "$LAST_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "New changes detected! ($LAST_COMMIT -> $LATEST_COMMIT)"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No new changes"
          fi
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "First time setup"
        fi
        
        echo "$LATEST_COMMIT" > "$CACHE_FILE"

    - name: Send Bark notification
      if: steps.monitor.outputs.has_changes == 'true'
      env:
        BARK_URL: ${{ secrets.BARK_URL }}
      run: |
        LATEST_COMMIT=$(cat .monitor-cache/current_commit.txt 2>/dev/null || echo "unknown")
        COMMIT_MESSAGE=$(cat .monitor-cache/current_message.txt 2>/dev/null || echo "No message")
        COMMIT_AUTHOR=$(cat .monitor-cache/current_author.txt 2>/dev/null || echo "Unknown")
        COMMIT_DATE=$(cat .monitor-cache/current_date.txt 2>/dev/null || echo "Unknown")
        COMMIT_URL=$(cat .monitor-cache/current_url.txt 2>/dev/null || echo "")
        
        if [ "$COMMIT_DATE" != "Unknown" ]; then
          FORMATTED_DATE=$(date -d "$COMMIT_DATE" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "$COMMIT_DATE")
        else
          FORMATTED_DATE="Unknown"
        fi
        
        TITLE="LobeChat Database Dockerfile Updated"
        BODY="Message: ${COMMIT_MESSAGE}\nAuthor: ${COMMIT_AUTHOR}\nDate: ${FORMATTED_DATE}\nCommit: ${LATEST_COMMIT:0:8}"
        
        if [ -n "$BARK_URL" ]; then
          HTTP_CODE=$(curl -w "%{http_code}" -s -o /dev/null -X POST "$BARK_URL" \
            -d "title=$TITLE" \
            -d "body=$BODY" \
            -d "url=$COMMIT_URL" \
            -d "group=GitHub Monitor")
          
          echo "Bark notification sent"
          echo "HTTP Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "Notification sent successfully"
          else
            echo "Notification may have failed (HTTP $HTTP_CODE)"
          fi
        else
          echo "BARK_URL not configured"
          exit 1
        fi