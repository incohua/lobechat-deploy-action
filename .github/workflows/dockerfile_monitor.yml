name: Enhanced LobeChat Dockerfile Monitor

on:
  schedule:
    - cron: "0 */6 * * *" # æ¯ 6 å°æ—¶æ£€æŸ¥ä¸€æ¬¡
  workflow_dispatch:
    inputs:
      force_notify:
        description: 'Force send notification'
        required: false
        default: 'false'
        type: boolean

env:
  REPO_OWNER: lobehub
  REPO_NAME: lobe-chat
  TARGET_FILE: Dockerfile.database

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repo
      uses: actions/checkout@v4
      
    - name: Setup monitoring cache
      uses: actions/cache@v3
      with:
        path: |
          .monitor-cache/
        key: lobechat-monitor-${{ github.run_id }}
        restore-keys: |
          lobechat-monitor-

    - name: Initialize monitoring
      run: |
        mkdir -p .monitor-cache
        
    - name: Check for changes
      id: monitor
      run: |
        # è·å–ç›®æ ‡æ–‡ä»¶çš„æœ€æ–°æäº¤
        API_URL="https://api.github.com/repos/${{ env.REPO_OWNER }}/${{ env.REPO_NAME }}/commits"
        RESPONSE=$(curl -s "$API_URL?path=${{ env.TARGET_FILE }}&per_page=1")
        
        if [ "$RESPONSE" = "[]" ]; then
          echo "âŒ File not found or no commits"
          exit 1
        fi
        
        LATEST_COMMIT=$(echo "$RESPONSE" | jq -r '.[0].sha')
        COMMIT_MESSAGE=$(echo "$RESPONSE" | jq -r '.[0].commit.message')
        COMMIT_AUTHOR=$(echo "$RESPONSE" | jq -r '.[0].commit.author.name')
        COMMIT_DATE=$(echo "$RESPONSE" | jq -r '.[0].commit.author.date')
        COMMIT_URL=$(echo "$RESPONSE" | jq -r '.[0].html_url')
        
        echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
        echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
        echo "commit_author=$COMMIT_AUTHOR" >> $GITHUB_OUTPUT
        echo "commit_date=$COMMIT_DATE" >> $GITHUB_OUTPUT
        echo "commit_url=$COMMIT_URL" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        CACHE_FILE=".monitor-cache/last_commit.txt"
        if [ -f "$CACHE_FILE" ]; then
          LAST_COMMIT=$(cat "$CACHE_FILE")
          if [ "$LATEST_COMMIT" != "$LAST_COMMIT" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… New changes detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No new changes"
          fi
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ†• First time setup"
        fi
        
        # ä¿å­˜å½“å‰æäº¤ä»¥ä¾›ä¸‹æ¬¡æ¯”è¾ƒ
        echo "$LATEST_COMMIT" > "$CACHE_FILE"

    - name: Send Bark notification
      if: steps.monitor.outputs.has_changes == 'true' || github.event.inputs.force_notify == 'true'
      env:
        BARK_URL: ${{ secrets.BARK_URL }}
      run: |
        # æ ¼å¼åŒ–æ—¶é—´
        FORMATTED_DATE=$(date -d "${{ steps.monitor.outputs.commit_date }}" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "${{ steps.monitor.outputs.commit_date }}")
        
        # æ„é€ é€šçŸ¥å†…å®¹
        TITLE="ğŸ³ LobeChat Database Dockerfile å·²æ›´æ–°"
        BODY="ğŸ“ ${{ steps.monitor.outputs.commit_message }}

        ğŸ‘¤ ä½œè€…: ${{ steps.monitor.outputs.commit_author }}
        ğŸ“… æ—¶é—´: $FORMATTED_DATE
        ğŸ” æäº¤: ${{ steps.monitor.outputs.latest_commit }}

        ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’"
        
        # å‘é€é€šçŸ¥
        RESPONSE=$(curl -w "%{http_code}" -s -X POST "$BARK_URL" \
          -H "Content-Type: application/json; charset=utf-8" \
          -d "{
            \"title\": \"$TITLE\",
            \"body\": \"$BODY\",
            \"group\": \"GitHubç›‘æ§\",
            \"url\": \"${{ steps.monitor.outputs.commit_url }}\",
            \"sound\": \"update\",
            \"badge\": 1
          }")
        
        echo "ğŸ“± Bark notification sent, response: $RESPONSE"